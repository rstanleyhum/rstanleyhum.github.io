<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Stanley Hum's website</title>
  <link rel="stylesheet" href='https:&#x2F;&#x2F;www.stanleyhum.com&#x2F;css/mybulma.css'>
</head>

<body>
  <nav class="navbar" role="navigation" aria-label="main navigation">
    <div class="navbar-brand">
        <div class="navbar-item">
            <a class="navbar-item" href="/"><b>R. Stanley Hum</b></a>
        </div>

      <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicExample">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>
  
    <div id="navbarBasicExample" class="navbar-menu">
        <div class="navbar-start">
            <a class="navbar-item" href="/blog/">Current</a>
            <a class="navbar-item" href="/archive/">Archived</a>
        </div>

        <div class="navbar-end">
            <div class="navbar-item">
                <a class="navbar-item" href="mailto:r.stanley.hum@stanleyhum.com">Email</a>
                <a class="navbar-item" href="https://github.com/rstanleyhum">GitHub</a>
                <a class="navbar-item" href="https://www.linkedin.com/in/rstanleyhum">LinkedIn</a>
                <a class="navbar-item" href="https://twitter.com/rstanleyhum">Twitter</a>  
            </div>
        </div>
    </div>
  </nav>
  <section class="section mx-6">
    <div class="container mx-6 px-6">
        
<h1 class="title">
  Embedding Python 2.7 into Golang on Windows 10
</h1>
<p class="subtitle"><strong>April 22, 2018</strong></p>
<p>So I've been working on a healthcare data science project with Python 3, Pandas, and SciKit-Learn. Unfortunately, the project uses Java and I'm not interested in re-coding all of the data cleaning and the machine learning code in Java. So I've decided to look at creating a microservice. In order to make the microservice a standalone windows executable, I decided to look at writing a Golang program which embeds Python.</p>
<p>The inspiration for this project was https://www.datadoghq.com/blog/engineering/cgo-and-python/.</p>
<p>First, I needed a C compiler for Cgo. I can use Scoop (http://scoop.sh) to install my tools.</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">
scoop install go</span><span style="color:#c0c5ce;">
scoop install python27</span><span style="color:#c0c5ce;">
scoop install gcc</span><span style="color:#c0c5ce;">
scoop install pkg-config</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span></code></pre>
<p>Scoop allows me to install everything in userspace so that I don't need to have administrative privileges.</p>
<p>Second, there are some configurations that I need to make things work.</p>
<p>Scoop installs the apps in C:\Users&lt;username&gt;\scoop\apps. Thus we need to use those to reference in the compiler.</p>
<p>pkg-config is not standardized across the distributions and definitely not on Windows. We need to set up a directory for the .pc files used by pkg-config.</p>
<p>I've placed them in $GOPATH\apps\pkgconfig\share. I created the directory then placed a file called python-2.7.pc with the following contents.</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">
Name: Python</span><span style="color:#c0c5ce;">
Description: Python library</span><span style="color:#c0c5ce;">
Requires:</span><span style="color:#c0c5ce;">
Version: 2.7</span><span style="color:#c0c5ce;">
Libs.private: -lpthread -ldl -lutil</span><span style="color:#c0c5ce;">
Libs: -L&quot;C:/Users/&lt;username&gt;/scoop/apps/python27/current&quot; -lpython27</span><span style="color:#c0c5ce;">
Cflags: -I&quot;C:/Users/&lt;username&gt;/scoop/apps/python27/current/include&quot; -D MS_WIN64</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span></code></pre>
<p>You need the -D MS_WIN64 for the compiler to work.</p>
<p>In the golang src directory, create a main.go as follows:</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">
package main</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
// #cgo pkg-config: python-2.7</span><span style="color:#c0c5ce;">
// #include &lt;Python.h&gt;</span><span style="color:#c0c5ce;">
import &quot;C&quot;</span><span style="color:#c0c5ce;">
import (</span><span style="color:#c0c5ce;">
    &quot;fmt&quot;</span><span style="color:#c0c5ce;">
)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
func main() {</span><span style="color:#c0c5ce;">
    fmt.Println(&quot;Hello World&quot;)</span><span style="color:#c0c5ce;">
    C.Py_Initialize()</span><span style="color:#c0c5ce;">
    fmt.Println(C.GoString(C.Py_GetVersion()))</span><span style="color:#c0c5ce;">
    C.Py_Finalize()</span><span style="color:#c0c5ce;">
}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span></code></pre>
<p>Now in order for this to work then the python27.dll file from the 'current' directory (above) needs to be in the src directory.</p>
<p>Then do a</p>
<pre style="background-color:#2b303b;">
<code class="language-shell" data-lang="shell"><span style="color:#c0c5ce;">go build .</span><span style="color:#c0c5ce;">
</span></code></pre>
<p>Running the executable should give the </p>
<pre style="background-color:#2b303b;">
<code class="language-shell" data-lang="shell"><span style="color:#c0c5ce;">Hello World</span><span style="color:#c0c5ce;">
2.7.14 (v2.7.14:84471935ed, Sep 16 2017, 20:25:58) [MSC v.1500 64 bit (AMD64)]</span><span style="color:#c0c5ce;">
</span></code></pre>
<p>Now if I use the nice open source library at https://github.com/sbinet/go-python then we get ...</p>
<pre style="background-color:#2b303b;">
<code class="language-python" data-lang="python"><span style="color:#c0c5ce;">package main</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">(</span><span style="color:#c0c5ce;">
    &quot;</span><span style="color:#a3be8c;">github.com/sbinet/go-python</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#c0c5ce;">
)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
func </span><span style="color:#bf616a;">main</span><span style="color:#c0c5ce;">() {</span><span style="color:#c0c5ce;">
    python.</span><span style="color:#bf616a;">Initialize</span><span style="color:#c0c5ce;">()</span><span style="color:#c0c5ce;">
    python.</span><span style="color:#bf616a;">PyRun_SimpleString</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">print (&#39;hello, world!&#39;)</span><span style="color:#c0c5ce;">&quot;)</span><span style="color:#c0c5ce;">
    python.</span><span style="color:#bf616a;">Finalize</span><span style="color:#c0c5ce;">()</span><span style="color:#c0c5ce;">
}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span></code></pre>
<p>And you get ...</p>
<pre style="background-color:#2b303b;">
<code class="language-shell" data-lang="shell"><span style="color:#c0c5ce;">hello, world!</span><span style="color:#c0c5ce;">
</span></code></pre>

    </div>
  </section>
</body>

</html>
